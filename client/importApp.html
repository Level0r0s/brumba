<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Import App</title>
 	<link rel="stylesheet" href="css/brumba.css" type="text/css" media="all" />

	<script src="js/lib/jquery.min.js" type="text/javascript"></script>
	<script src="js/util.js" type="text/javascript"></script>
	<script src="js/client.js" type="text/javascript"></script>

	<style>
		body { font-size: 62.5%; }
	</style>

<script>
var files = null
	, db = 'iocoma'

$(function() {
	remote( {cmd:'GET', db:db, coll:'fs.files'}, function(res) {
		if ( res.dbret )  alert( res.dbret )
		else  files = res
	})

	$.get("tmp/FORMS.xml", function(data) {
var n = 0
		$(data).find('Form').each( function() {
			var form = $( this )
				, isTabular = false
				, name = form.find('> Properties UID').text()
//if ( n++ == 3 ) {			
//if ( name == 'About' ) {			
			var htm = $( '<form class="br-form" />' )
			if ( form.attr('type') == 'T' ) {
				htm.addClass('br-tabular')
				isTabular = true
			}
			htm.attr('id', name )
			htm.css( 'width', 1200 )
			htm.css( 'height', 720 )
			if ( isTabular ) {
				var pan = form.find('> Panel')
				for ( var i=0; i < pan.length; i++ ) {
					var band = $( '<div class="br-band split-s" style="width: 100%;" />' )
					switch ( i ) {
						case 0:  band.addClass('br-header');  break
						case 1:  band.addClass('br-detail');  break
						case 2:  band.addClass('br-total');  break
					}
					band.css( 'height', $(pan[i]).find('> Properties Height').text() )
					$(pan[i]).find('>').each( function() {
						var el = element( this )
						if ( el )  band.append( el )
					})
					htm.append( band )
				}
			} else {
				form.find('>').each( function() {
					var el = element( this )
					if ( el )  htm.append( el )
				})
			}
			
			var dat = { name: name, html: outerHtml( htm ) }
			remote( { db: db, cmd: 'POST', coll: 'forms' }, function(res) {
				if ( res.dbret )  alert( res )
			}, dat )
//$('#form').append( htm )
//}
		})
	})
});


function element( xml ) {
	var el = null, $xml = $(xml)
	switch ( xml.tagName ) {
		case 'Field':  el = field( $xml );  break
		case 'Label':  el = label( $xml );  break
		case 'Button':  el = button( $xml );  break
		case 'Rectangle':  el = rectangle( $xml );  break
		case 'Image':  el = image( $xml );  break
	}
	return el
}


function field( xml ) {
	var htm, type = xml.find('Type').text()
	switch ( type ) {
		case 'String':  htm = $('<input type="text"/>');  break
		case 'Numeric':  htm = $('<input type="number"/>');  break
		case 'Text':  htm = $('<textarea />');  break
		case 'Date':  htm = $('<input type="date"/>');  break
		case 'DropDown':  htm = $('<select />');  break
		case 'FileLink':  htm = $('<input type="filelink"/>');  break
		case 'CheckBox':  htm = $('<input type="checkbox"/>');  break
		case 'Time':  htm = $('<input type="time"/>');  break
		case 'DateTime':  htm = $('<input type="datetime"/>');  break
		case 'ImageLink':  htm = $('<image />');  break
		case 'Color':  htm = $('<input type="color"/>');  break
		case 'Password':  htm = $('<input type="password"/>');  break
	}
	htm.addClass('br-field')
	properties( xml, htm )
	htm.attr( 'id', xml.find('UID').text() )
	var val = xml.find('MaxChars').text()
	if ( val != '0' )  htm.attr( 'maxlength', val )
	return htm
}


function label( xml ) {
	var htm = $('<label class="br-label" >' + xml.find('Caption').text() + '</label>')
	properties( xml, htm )
	return htm
}


function button( xml ) {
	var htm = $('<button class="br-button">' + xml.find('Caption').text() + '</button>')
	properties( xml, htm )
	return htm
}


function rectangle( xml ) {
	var htm = $('<div class="br-rectangle"></div>')
	properties( xml, htm )
	return htm
}


function image( xml ) {
	var htm = $('<img></img>')
	properties( xml, htm )
	var oldid = xml.find('FileID').text()
	for ( var i=0; i < files.length; i++ ) {
		if ( files[i].metadata.oldid == oldid ) {
			htm.attr( 'src', '/brumba?{"cmd":"FILE", "mode":"r", "db":"'+db+'", "_id":"'+files[i]._id+'"}')
		}
	}
	return htm
}


function properties( xml, htm ) {
	htm.css( 'left', xml.find('Left').text() + 'px' )
	htm.css( 'top', xml.find('Top').text() + 'px' )
	htm.css( 'width', xml.find('Width').text() + 'px' )
	var val = xml.find('Height').text()
	if ( parseInt(val, 10) > 17 )  htm.css( 'height', val + 'px' )
	if ( xml[0].tagName != 'Button' && xml.find('Type').text() != 'DropDown' ) {
		val = xml.find('FillColor').text()
		if ( val != '00000000' && val != 'FFFFFFFF' )  htm.css( 'background', '#'+ val.substr(0,6) )
		val = xml.find('TextColor').text()
		if ( val != '00000000' && val != 'FFFFFFFF' )  htm.css( 'color', '#'+ '#'+ val.substr(0,6) )
	}
	val = xml.find('AlignH').text()
	if ( val == '1' )  htm.css( 'text-align', 'center' )
	else if ( val == '2' )  htm.css( 'text-align', 'right' )
	if ( xml.find('AlignH').text() == 'false' )  htm.prop( 'hidden', true )
}

</script>


</head>

<body>
	<div id="form">
	</div>
</body>
</html>
