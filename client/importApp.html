<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Import App</title>
 	<link rel="stylesheet" href="css/brumba.css" type="text/css" media="all" />

	<script src="js/lib/jquery.min.js" type="text/javascript"></script>
	<script src="js/util.js" type="text/javascript"></script>
	<script src="js/client.js" type="text/javascript"></script>

	<style>
		body { font-size: 62.5%; }
	</style>

<script>
var files = null
	, lang = null
	, db = 'iocoma'
	, br = {usercode: 'ide'}


function importApp() {
	remote( {cmd:'GET', db:db, coll:'fs.files'}, function(res) {
		if ( res.err )  alert( 'fs.files' )
		else {
			files = res
			remote( {cmd:'GET', db:db, coll:'languages', fields:{default:1, ro:1}}, function(res) {
				if ( res.err )  alert( 'languages' )
				else {
					lang = res
					convert()
				}
			})
		}
	})

}


function convert() {
	$.get("tmp/FORMS.xml", function(data) {
		$(data).find('Form').each( function() {
			var form = $( this )
				, isTabular = false
				, name = form.find('> Properties UID').text()
//console.log( name )

//if ( name == 'VehicleSetup' )	{

			var htm = $( '<form class="br-form" />' )
			if ( form.attr('type') == 'T' ) {
				htm.addClass('br-tabular')
				isTabular = true
			}
			htm.attr('id', name )
			var qs = $(form.children()[0]).find('Query').text()
			if ( qs ) htm.attr('data-query', query(qs, htm))
			if ( isTabular ) {
				var pan = form.find('> Panel')
				for ( var i=0; i < pan.length; i++ ) {
					var band = $( '<div class="br-band split-s" style="width: 100%;" />' )
					switch ( i ) {
						case 0:  band.addClass('br-header');  break
						case 1:  band.addClass('br-detail');  break
						case 2:  band.addClass('br-total');  break
					}
					band.css( 'height', $(pan[i]).find('> Properties Height').text() )
					$(pan[i]).find('>').each( function() {
						var el = element( this )
						if ( el )  band.append( el )
					})
					htm.append( band )
				}
			} else {
				form.find('>').each( function() {
					var el = element( this )
					if ( el )  htm.append( el )
				})
			}
			
			var dat = { name: name, html: outerHtml( htm ) }
			remote( { db: db, cmd: 'POST', coll: 'forms' }, function(res) {
				if ( res.dbret )  alert( res )
			}, dat )

//$('#form').append( htm ) }

		})
	})
}


function element( xml ) {
	var el = null, $xml = $(xml)
	switch ( xml.tagName ) {
		case 'Field':  el = field( $xml );  break
		case 'Label':  el = label( $xml );  break
		case 'Button':  el = button( $xml );  break
		case 'Rectangle':  el = rectangle( $xml );  break
		case 'Image':  el = image( $xml );  break
	}
	return el
}


function field( xml ) {
	var htm, type = xml.find('Type').text()
	switch ( type ) {
		case 'String':  htm = $('<input type="text"/>');  break
		case 'Numeric':  htm = $('<input type="number"/>');  break
		case 'Text':  htm = $('<textarea />');  break
		case 'Date':  htm = $('<input type="date"/>');  break
		case 'DropDown':  htm = $('<select />');  break
		case 'FileLink':  htm = $('<input type="filelink"/>');  break
		case 'CheckBox':  htm = $('<input type="checkbox"/>');  break
		case 'Time':  htm = $('<input type="time"/>');  break
		case 'DateTime':  htm = $('<input type="datetime"/>');  break
		case 'ImageLink':  htm = $('<image />');  break
		case 'Color':  htm = $('<input type="color"/>');  break
		case 'Password':  htm = $('<input type="password"/>');  break
	}
	htm.addClass('br-field')
	properties( xml, htm )
	htm.attr( 'id', xml.find('UID').text() )
	var val = xml.find('MaxChars').text()
	if ( val && val != '0' )  htm.attr( 'maxlength', val )
	return htm
}


function label( xml ) {
	var htm = $('<label class="br-label" >' + eng(xml.find('Caption').text()) + '</label>')
	properties( xml, htm )
	return htm
}


function button( xml ) {
	var htm = $('<button class="br-button">' + eng(xml.find('Caption').text()) + '</button>')
	properties( xml, htm )
	return htm
}


function eng( text ) {
	for ( var i=lang.length-1; i >= 0; i-- ) {
		if ( lang[i].ro == text ) return lang[i].default
	}
	return text
}


function rectangle( xml ) {
	var htm = $('<label class="br-rectangle"></label>')
	properties( xml, htm )
	return htm
}


function image( xml ) {
	var htm = $('<img></img>')
	properties( xml, htm )
	var oldid = xml.find('FileID').text()
	for ( var i=0; i < files.length; i++ ) {
		if ( files[i].metadata.oldid == oldid ) {
			htm.attr('src', '#')
			htm.attr('data-id', files[i]._id)
		}
	}
	return htm
}


function properties( xml, htm ) {
	htm.css( 'left', xml.find('Left').text() + 'px' )
	htm.css( 'top', xml.find('Top').text() + 'px' )
	htm.css( 'width', xml.find('Width').text() + 'px' )
	var val = xml.find('Height').text()
	if ( parseInt(val, 10) > 17 )  htm.css( 'height', val + 'px' )
	/*if ( xml[0].tagName != 'Button' && xml.find('Type').text() != 'DropDown' ) {
		val = xml.find('FillColor').text()
		if ( val != '00000000' && val != 'FFFFFFFF' )  htm.css( 'background', '#'+ val.substr(0,6) )
		val = xml.find('TextColor').text()
		if ( val != '00000000' && val != 'FFFFFFFF' )  htm.css( 'color', '#'+ '#'+ val.substr(0,6) )
	}*/
	val = xml.find('AlignH').text()
	if ( val == '1' )  htm.css('text-align', 'center')
	else if ( val == '2' )  htm.css('text-align', 'right')
	if ( xml.find('AlignH').text() == 'false' )  htm.prop('hidden', true)
	val = xml.find('Font').text()
	if ( val ) {
		var sp = val.split('.')
		if ( sp[1] == 'b' ) htm.css('font', 'bold '+sp[2]+'px Arial')
	}
	val = xml.find('Query').text()
	if ( val ) htm.attr('data-query', query(val))
	val = xml.find('Display').text()
	if ( val ) htm.attr('data-fields', '_id, '+val)
}


function query( qs, form ) {
	if ( qs.substr(0,4) == 'TXT:' ) {
		var spv = strSplit(qs.substr(4), ';')
			, s = '['
		for ( var i=0; i < spv.length; i++ ) {
			var sp = strSplit(spv[i], ',')
			if ( i > 0 ) s += ', '
			s += '{val:'
			if ( isNumber(sp[0]) ) s += sp[0]
			else s += "'" + sp[0] + "'"
			if ( sp[1] ) s += ", txt:'" + sp[1] + "'"
			s += '}'
		}
		s += ']'
		return s
	} else if ( qs.substr(0,4) == 'SRV:' ) {
		var sp = strSplit(qs.substr(4), '(')
			, s = "{ cmd: 'SRV', script: '" + sp[0] + "' }" 
		return s
	} else {
		var sp = strSplit(qs, '@')
			, ord = sp[1]
		sp = strSplit(sp[0], ':')
		var s = "{ coll: '" + sp[0] + "'"
		if ( sp[1] ) {
			s += ", fields: '" + strDelBet(sp[1], '(', ')') + "'"
			if ( form ) {
				var sf = strRep(sp[1], '(', ':')
				form.attr('data-fields', strRep(sf, ')', ''))
			}
		}
		if ( sp[2] ) s += ', where: {' + sp[2] + '}'
		if ( ord ) {
			sp = strSplit(ord, ',')
			s += ', sort: {'
			for ( var i=0; i < sp.length; i++ ) {
				if ( i > 0 ) s += ', '
				s += sp[i] + ':1'
			}
			s += '}'
		}
		s += ' }'
		return s
	}
}

</script>


</head>

<body>
	<button onclick="importApp()">Import App</button>
	<div id="form">
	</div>
</body>
</html>
